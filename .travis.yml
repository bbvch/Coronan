---
language: cpp
os: linux
dist: bionic

services:
    - docker

cache: # see https://docs.travis-ci.com/user/caching/
    - directories:
          - $HOME/.ccache
          - $HOME/.conan
          - $HOME/.conan-clang11
          - nix/store

env:
    global:
        - CODACY_PROJECT_TOKEN=03851e6e31c544248a4f5f799a7eac4c
        - DOCKER_WORKDIR="/workspace"
        - CONAN_UPDATE_CMD="pip3 install --upgrade conan"

notifications:
    email:
        recipients:
            - michel.estermann@bbv.ch
        on_success: change
        on_failure: always

install:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

jobs:
    include:
        - os: osx
          compiler: gcc
          osx_image: xcode11.2
          addons:
              homebrew:
                  packages:
                      - qt
                  update: false
          env:
              - GCC_VER="9"
              - MATRIX_EVAL="CC=gcc-${GCC_VER} && CXX=g++-${GCC_VER}"
          install:
              - python3 -m pip install --upgrade pip setuptools
              - python3 -m pip install conan cmake
              - conan --version
          before_script:
              - eval "${MATRIX_EVAL}"
              - export Qt5_DIR=/usr/local/opt/qt/lib/cmake
              - cmake -S . -B ./build -G"Unix Makefiles" -DCMAKE_CXX_COMPILER=g++-${GCC_VER} -DCMAKE_CC_COMPILER=gcc-${GCC_VER} -DENABLE_TESTING=OFF -DCMAKE_BUILD_TYPE=Release
          script:
              - cmake --build ./build -- -j16
        - os: osx
          compiler: clang
          osx_image: xcode11.2
          addons:
              homebrew:
                  packages:
                      - qt
                  update: false
          install:
              - python3 -m pip install --upgrade pip setuptools
              - python3 -m pip install conan cmake
              - conan --version
          before_script:
              - export Qt5_DIR=/usr/local/opt/qt/lib/cmake
              - cmake -S . -B ./build -G"Unix Makefiles" -DENABLE_TESTING=OFF -DCMAKE_BUILD_TYPE=Release
          script:
              - cmake --build ./build -- -j16

        - os: linux
          dist: focal
          compiler: gcc
          addons:
              apt:
                  sources:
                      - sourceline: ppa:beineri/opt-qt-5.15.2-focal
                  update: true
                  packages:
                      - ninja-build
                      - qt515base
                      - qt515charts-no-lgpl
                      - qt515tools
                      - libc6-i386
                      - libgl-dev
                      - libgl1-mesa-dev
                      - mesa-common-dev
          install:
              - python3 -m pip install --upgrade pip setuptools
              - python3 -m pip install conan cmake
              - conan --version
          before_script:
              - /opt/qt515/bin/qt515-env.sh
              - cmake -S . -B ./build -G"Ninja" -DCMAKE_BUILD_TYPE=Release
          script:
              - cmake --build ./build -- -j16

        - name: gcc7 coverage (docker)
          env:
              - DOCKER_IMAGE=bbvch/conan_qt-5.14.2_builder_gcc7
              - COVERAGE_FILE="coverage.info"
          script:
              - docker run -t -v ${TRAVIS_BUILD_DIR}:${DOCKER_WORKDIR} -w ${DOCKER_WORKDIR} ${DOCKER_IMAGE} /bin/bash -c "${CONAN_UPDATE_CMD} && ./build.sh
                --cov=${COVERAGE_FILE}"
          after_success:
              - bash <(curl -s https://codecov.io/bash) -f ${COVERAGE_FILE} || echo 'Codecov did not collect coverage reports'
              - bash <(curl -Ls https://coverage.codacy.com/get.sh) report -r ${COVERAGE_FILE} || echo 'codacy did not collect coverage reports'

        - name: gcc9 debug (docker)
          env:
              - DOCKER_IMAGE=bbvch/conan_qt-5.14.2_builder_gcc9
          script:
              - docker run -t -v ${TRAVIS_BUILD_DIR}:${DOCKER_WORKDIR} -w ${DOCKER_WORKDIR} ${DOCKER_IMAGE} /bin/bash -c "${CONAN_UPDATE_CMD} && ./build.sh
                -r"

        - name: gcc9 release (docker)
          env:
              - DOCKER_IMAGE=bbvch/conan_qt-5.14.2_builder_gcc9
          script:
              - docker run -t -v ${TRAVIS_BUILD_DIR}:${DOCKER_WORKDIR} -w ${DOCKER_WORKDIR} ${DOCKER_IMAGE} /bin/bash -c "${CONAN_UPDATE_CMD} && ./build.sh
                -r"

        - name: clang7 debug (docker)
          env:
              - DOCKER_IMAGE=bbvch/conan_qt-5.14.2_builder_clang7
          script:
              - docker run -t -v ${TRAVIS_BUILD_DIR}:${DOCKER_WORKDIR} -w ${DOCKER_WORKDIR} ${DOCKER_IMAGE} /bin/bash -c "${CONAN_UPDATE_CMD} && ./build.sh"

        - name: clang8 debug (docker)
          env:
              - DOCKER_IMAGE=bbvch/conan_qt-5.14.2_builder_clang8
          script:
              - docker run -t -v ${TRAVIS_BUILD_DIR}:${DOCKER_WORKDIR} -w ${DOCKER_WORKDIR} ${DOCKER_IMAGE} /bin/bash -c "${CONAN_UPDATE_CMD} && ./build.sh"

        - name: clang9 debug (docker)
          env:
              - DOCKER_IMAGE=bbvch/conan_qt-5.14.2_builder_clang9
          script:
              - docker run -t -v ${TRAVIS_BUILD_DIR}:${DOCKER_WORKDIR} -w ${DOCKER_WORKDIR} ${DOCKER_IMAGE} /bin/bash -c "${CONAN_UPDATE_CMD} && ./build.sh"

        - name: clang9 release (docker)
          env:
              - DOCKER_IMAGE=bbvch/conan_qt-5.14.2_builder_clang9
          script:
              - docker run -t -v ${TRAVIS_BUILD_DIR}:${DOCKER_WORKDIR} -w ${DOCKER_WORKDIR} ${DOCKER_IMAGE} /bin/bash -c "${CONAN_UPDATE_CMD} && ./build.sh
                -r"

        - language: nix
          name: nix build ninja gcc10
          env:
              - CONAN_USER_HOME="${HOME}/.conan"
          script:
              - nix-shell --command "cmake -S ${TRAVIS_BUILD_DIR} --preset=linux-ninja"
              - nix-shell --command "cmake --build --preset=linux-build"

        - language: nix
          name: nix build ninja clang11
          env:
              - CONAN_USER_HOME="${HOME}/.conan-clang11"
          script:
              - nix-shell --command "cmake -S ${TRAVIS_BUILD_DIR} --preset=linux-ninja-clang"
              - nix-shell --command "cmake --build --preset=linux-build"
